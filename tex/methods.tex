\chapter{Классификация существующих\linebreak методов решения}

В данном разделе будут описаны существующие методы решения, выделены критерии их оценки и будет проведено сравнение описанных методов по выделенным критериям.

\section{Методы решения}

Существуют следующие методы изменения ядра Linux:

\begin{itemize}
	\item требующие перезагрузки системы;
	\item переноса;
	\item динамические.
\end{itemize}

\subsection{Методы, требующие перезагрузки системы}

\cite{reboot}

В процессе внесения изменений в ядро операционной системы возникает следующая проблема: появляется время простоя, которое состоит из времени простоя приложения и простоя ядра.

TODO

\subsection{Метод переноса}

Идея данного метода \cite{dynamic} заключается в следующем: на другом компьютере запускается измененное ядро, на него переносятся запущенные процессы старого ядра, и оно останавливается. В существующих решениях в качестве другого компьютера используется виртуальная машина, установленная на физической машине, требующей обновления ядра. Необходимо общее хранилище(сервер), которое подключено и к старому, и к новому ядрам. Патч применяется в три этапа.

На первом этапе собирается информация о состоянии операционной системы: подсчитывается число потоков, выполняемых в исправляемом коде, вызывается функция запуска, выполняется инициализация перед передачей управления виртуальной машине.

На втором этапе сервер начинается исправление структур данных и функций. Если измененный модуль не находится в состоянии покоя, обе версии структур данных должны существовать во время процесса исправления. Для обеспечения согласованности структур данных, страницы исходных данных и новых данных защищены. Перехват доступа к ним контролируется виртуальной машиной. То есть, при попытке изменить отслеживаемую страницу управление будет передано виртуальной машине. В этот момент сравнивается содержимое двух версий и вызывается функцию передачи состояния.

На последнем этапе отключается контроль исходных структур данных. Для этого используется метод обхода стека. В случае, если соответствующая исходные структуры используются, адрес возврата исходной функции заменяется адресом функции-заглушки, которые позволяют определить, используется ли еще обновленная функция. Затем выполняется очистка кода старой версии и устанавливается флаг завершения патчинга.

При применении данного метода время простоя невелико. Главным минусом является высокое потребление ресурсов центрального процессора, сети и объема памяти.

TODO

\subsection{Динамические методы}

Данные методы \cite{dynamic} позволяют применять патчи во время выполнения процессов. Решение состоит из двух этапов.

Для того, чтобы создать измененный код, проводится анализ обновленной и старой	версий. Для этого собирается два варианта ядра: сборка неизмененного кода и сборка измененного кода. В отличие от поиска различий в исходном коде, анализ объектного кода позволяет понять, какие функции были изменены в патче. Большинство функций ядра, которые не были изменены патчем, будут иметь одинаковые объектные коды. Обнаруженные измененные функции помещаются в основной модуль для загрузки в ядро.

Следующий этап необходим для обнаружения встраиваемых функций и неуникальных символов. Для этого проводится сравнение работающего кода ядра и скомпилированного кода. Этот процесс называется предварительным сопоставлением.

Для применения данного метода необходимо определить состояние ядра, когда каждая заменяемая функция будет находиться в состоянии покоя, что является условием безопасного внесения изменений. В этом случае модуль может быть загружен в ядро. Проверка условия безопасного внесения изменений в случае неудачи возобновится через некоторое время. После нескольких неудачных попыток достичь безопасного состояния для применения патча процесс прерывается. Новые инструкции будут вставлены в необновленные функции путем бинарной перезаписи. Бинарная перезапись - это перенаправление вызова функции из исходной в исправленную, для чего используется прыжок к первым пяти или шести байтам функции.

Некоторые решения на основе динамических методов не поддерживают семантические изменения. Кроме того, возникают сложности с изменением типов и структур данных,нестабильных типов данных и функций ядра, которые всегда находятся в стеке вызовов потоков ядра.

Данные методы решают проблему с временем простоя.

TODO

\section{Критерии оценки методов}

\begin{itemize}
	\item сохранение функционирования программной системы.
\end{itemize}

TODO

\section{Сравнение методов}

TODO

\section{Вывод}

TODO
